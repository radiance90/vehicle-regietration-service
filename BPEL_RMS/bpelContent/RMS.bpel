<!-- RMS BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Tue May 26 23:35:54 EST 2015 -->
<bpel:process name="RMS"
         targetNamespace="http://soacourse.unsw.edu.au/rms"
         suppressJoinFailure="yes"
         xmlns:tns="http://soacourse.unsw.edu.au/rms"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:green="http://soacourse.unsw.edu.au/greenslip"
	 	 xmlns:pink="http://soacourse.unsw.edu.au/pinkslip"
		 xmlns:greendef="http://soacourse.unsw.edu.au/greenslipdefinitions"
		 xmlns:pinkdef="http://soacourse.unsw.edu.au/pinkslipdefinitions"
         >

    <!-- Import the client WSDL -->
	<bpel:import location="RMSArtifacts.wsdl" namespace="http://soacourse.unsw.edu.au/rms" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="greenslip.wsdl" namespace="http://soacourse.unsw.edu.au/greenslip" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="pinkslip.wsdl" namespace="http://soacourse.unsw.edu.au/pinkslip" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
		<!-- The 'client' role represents the requester of this service. -->
		<bpel:partnerLink name="client" partnerLinkType="tns:greenslipLinkType"
			myRole="green" />
		<bpel:partnerLink name="green" partnerLinkType="tns:greenslipLinkType"
			partnerRole="green" />
		<bpel:partnerLink name="pink" partnerLinkType="tns:pinkslipLinkType"
			partnerRole="pink" />
	</bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
		<!-- Reference to the message passed as input during initiation -->
		<bpel:variable name="clientRequest" messageType="green:GSCheck"></bpel:variable>
		<bpel:variable name="clientRequest2" messageType="pink:PSCheck"></bpel:variable>
		<bpel:variable name="clientRequest3" messageType="pink:VehicleAge"></bpel:variable>
		<!-- Reference to the message that will be returned to the requester -->
		<bpel:variable name="greenInfo" messageType="green:GSCheckResponse" />
		<bpel:variable name="pinkInfo" messageType="pink:PSCheckResponse" />
		<bpel:variable name="age" messageType="pink:VehicleAgeResponse" />
	</bpel:variables>
                  
        

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:flow name="main">
		<bpel:links>
			<bpel:link name="receive-to-assign0" />
			<bpel:link name="assign0-to-gscheck" />
			<bpel:link name="gscheck-to-reply" />
			<bpel:link name="gscheck-to-age" />
			
			<bpel:link name="age-to-assign1" />
			<bpel:link name="assign1-to-reply" />
			<bpel:link name="assign1-to-pscheck" />
			<bpel:link name="pscheck-to-assign2" />
			<bpel:link name="assign2-to-reply" />
		</bpel:links>
		
		<bpel:receive name="receiveInput" partnerLink="client"
			portType="green:GSCheckPT" operation="GSCheck" variable="clientRequest"
			createInstance="yes">

			<bpel:sources>
				<bpel:source linkName="receive-to-assign0"></bpel:source>
			</bpel:sources>
		</bpel:receive>
		
		<bpel:invoke name="gscheck" partnerLink="green"
			portType="green:GSCheckPT" operation="GSCheck" inputVariable="clientRequest"
			outputVariable="greenInfo">
			<bpel:targets>
				<bpel:target linkName="assign0-to-gscheck"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="gscheck-to-reply">
					<bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$greenInfo.renewalresp/greendef:passed != 'Green Slip Provider Called - Payment Check Passed']]></bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="gscheck-to-age">
					<bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$greenInfo.renewalresp/greendef:passed = 'Green Slip Provider Called - Payment Check Passed']]></bpel:transitionCondition>
				</bpel:source>
			</bpel:sources>
		</bpel:invoke>
		
		<bpel:invoke name="pscheck" partnerLink="pink"
			portType="pink:PSCheckPT" operation="PSCheck" inputVariable="clientRequest2"
			outputVariable="pinkInfo">
			<bpel:targets>
				<bpel:target linkName="assign1-to-pscheck"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="pscheck-to-assign2">
				</bpel:source>
			</bpel:sources>
		</bpel:invoke>
		
		<bpel:assign validate="no" name="assign0">
			<bpel:copy>
                <bpel:from><bpel:literal><ns2:renewalInformationMessage xmlns:ns2="http://soacourse.unsw.edu.au/pinkslipdefinitions" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  					<ns2:firstName>ns2:firstName</ns2:firstName>
  					<ns2:lastName>ns2:lastName</ns2:lastName>
  					<ns2:rego>ns2:rego</ns2:rego>
					</ns2:renewalInformationMessage>
				</bpel:literal></bpel:from>
                <bpel:to variable="clientRequest2" part="renewalreq"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from><bpel:literal><ns3:renewalInformationMessage xmlns:ns3="http://soacourse.unsw.edu.au/pinkslipdefinitions" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  					<ns3:firstName>ns3:firstName</ns3:firstName>
  					<ns3:lastName>ns3:lastName</ns3:lastName>
  					<ns3:rego>ns3:rego</ns3:rego>
					</ns3:renewalInformationMessage>
				</bpel:literal></bpel:from>
                <bpel:to variable="clientRequest3" part="renewalreq"></bpel:to>
            </bpel:copy>
            
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:firstName]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest2">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:firstName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:lastName]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest2">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:lastName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:rego]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest2">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:rego]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:firstName]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest3">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:firstName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:lastName]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest3">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:lastName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="renewalreq" variable="clientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:rego]]></bpel:query>
				</bpel:from>
				<bpel:to part="renewalreq" variable="clientRequest3">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pinkdef:rego]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:targets>
				<bpel:target linkName="receive-to-assign0"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="assign0-to-gscheck"></bpel:source>
			</bpel:sources>
			
		</bpel:assign>
		
		<bpel:invoke name="age" partnerLink="pink"
			portType="pink:PSCheckPT" operation="VehicleAge" inputVariable="clientRequest3"
			outputVariable="age">
			<bpel:targets>
				<bpel:target linkName="gscheck-to-age"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="age-to-assign1">
					<!-- <bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$age.renewalresp/pinkdef:age != 'Pink Slip Provider Called (Age Check) - Vehicle is more than 5 years old']]></bpel:transitionCondition> -->
				</bpel:source>
				<!-- <bpel:source linkName="age-to-pscheck">
					<bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$age.renewalresp/pinkdef:age = 'Pink Slip Provider Called (Age Check) - Vehicle is more than 5 years old']]></bpel:transitionCondition>
				</bpel:source> -->
			</bpel:sources>
		</bpel:invoke>
		
		<bpel:assign validate="no" name="assign1">

			<bpel:copy>
				<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[concat($greenInfo.renewalresp/greendef:passed,'<br />', $age.renewalresp/pinkdef:age)]]>
				</bpel:from>
				
				<bpel:to part="renewalresp" variable="greenInfo">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:passed]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:targets>
				<bpel:target linkName="age-to-assign1"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="assign1-to-reply">
				<bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$greenInfo.renewalresp/greendef:passed != 'Green Slip Provider Called - Payment Check Passed<br />Pink Slip Provider Called (Age Check) - Vehicle is more than 5 years old']]></bpel:transitionCondition>
				</bpel:source>
				<bpel:source linkName="assign1-to-pscheck">
				<bpel:transitionCondition
						expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
					<![CDATA[$greenInfo.renewalresp/greendef:passed = 'Green Slip Provider Called - Payment Check Passed<br />Pink Slip Provider Called (Age Check) - Vehicle is more than 5 years old']]></bpel:transitionCondition>
				</bpel:source>
			</bpel:sources>
		</bpel:assign>
		
		<bpel:assign validate="no" name="assign2">

			<bpel:copy>
				<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[concat($greenInfo.renewalresp/greendef:passed,'<br />', $pinkInfo.renewalresp/pinkdef:passed)]]>
				</bpel:from>
				
				<bpel:to part="renewalresp" variable="greenInfo">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[greendef:passed]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:targets>
				<bpel:target linkName="pscheck-to-assign2"></bpel:target>
			</bpel:targets>
			<bpel:sources>
				<bpel:source linkName="assign2-to-reply"></bpel:source>
			</bpel:sources>
		</bpel:assign>
		
		<bpel:reply name="replyOutput" partnerLink="client"
			portType="green:GSCheckPT" operation="GSCheck" variable="greenInfo">
			<bpel:targets>
				<bpel:target linkName="gscheck-to-reply"></bpel:target>
				<bpel:target linkName="assign1-to-reply"></bpel:target>
				<bpel:target linkName="assign2-to-reply"></bpel:target>
			</bpel:targets>
		</bpel:reply>

	</bpel:flow>
		
		
</bpel:process>

